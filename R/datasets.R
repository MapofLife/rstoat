#' @title View datasets
#'
#' @description List logged-in user's uploaded datasets (uploaded to https://mol.org through https://mol.org/upload).
#' Requires login, please run mol_login(<email_address>)
#'
#' @return A data frame of a users datasets and their associated ids.
#' @export
#'
#' @examples
#' \dontrun{
#' my_datasets()
#' }
my_datasets <- function () {
  get_json('user','datasets')
}

#' @title List all jobs
#'
#' @description List logged-in user's past and current annotation jobs.
#' Requires login, please run mol_login(<email_address>)
#'
#' @return A data.frame containing jobs metadata.
#' @export
#' @examples
#' \dontrun{
#' my_jobs()
#' }
my_jobs <- function () {
  get_json('user','annotations')
}

#' @title Retrieve annotation job details
#'
#' @description Get details of a batch annotation job. Requires login, please run mol_login(<email_address>).
#' Uses the output from my_jobs().
#'
#' @param annotation_id The annotation id from from my_jobs().
#'
#' @return A data.frame of layers and their statuses, along with the annotation_id, and the dataset_id for the custom annotation.
#' @export
#'
#' @examples
#' \dontrun{
#' job_details(<annotation_id>)
#' }
job_details <- function (annotation_id) {
  res <- get_json('user', 'annotations', annotation_id, simplifyVector = TRUE)
  res$params$title <-  res$name
  res$params$updated <- NULL
  res$params$created <- NULL
  res$params$annotation_id <- res$task_id
  res$params$dataset_id <- res$dataset_id
  res$params
}

#' @title Download annotation results
#'
#' @description Download results of a successfully completed batch annotation.
#' Requires login, please run mol_login(<email_address>)
#' Uses the output from my_jobs() for the annotation id.
#'
#' @param annotation_id The id of the annotation
#' @param dir The directory where to write the annotation.
#' @return The path of the downloaded annotation.
#' @export
#'
#' @examples
#' \dontrun{
#' download_annotation(<annotation_id>, <dir>)
#' }
download_annotation <- function (annotation_id, dir = 'annotation_results') {
  url <- build_url('user/annotations', annotation_id, 'download')
  annotation_url <- get_resp({
    httr::GET(url, get_auth_header(), ua())
  })
  if (is.null(annotation_url)) return(NULL)
  annotation_url <- annotation_url$url
  tmp_path <- tempfile()
  download_path <- paste0(dir, '/', annotation_id)
  if (!dir.exists(dir)) {
    dir.create(dir)
    message(paste0('Created directory: ', dir))
  }
  if (dir.exists(download_path)) {
    message('Annotation already downloaded.')
    return(NULL)
  }

  status <- utils::download.file(annotation_url, tmp_path, mode='wb')
  if (status == 0){
    message('Unzipping')
    utils::unzip(tmp_path, exdir=download_path)
    message(paste0('Annotation available at: ', download_path))
    return(download_path)
  } else {
    message('There was an error downloading your annotation.')
    return(NULL)
  }
}

#' @title View annotation job species
#'
#' @description View the species in a completed annotation and other details. Only works for successfully completed jobs.
#' Requires login, please run mol_login(<email_address>)
#' Uses the output from my_jobs().
#'
#' @param annotation_id The annotation id from from my_jobs().
#'
#' @return A data.frame, with species and counts in this annotation.
#' @export
#'
#' @examples
#' \dontrun{
#' job_species(<annotation_id>)
#' }
job_species <- function (annotation_id) {
  results <- get_json('user', 'annotations', annotation_id, 'species', simplifyVector = FALSE)
  results <- lapply(results, function(x) {
    count_per_product <- unlist(x$variables)
    counts <- data.frame(
      scientificname = x$scientificname,
      total_occurence_data = x$counts,
      code = internal_to_code(names(count_per_product)),
      annotated = count_per_product
    )
  })
  do.call(rbind.data.frame, results)
  row.names(results) <- c()
  results
}

